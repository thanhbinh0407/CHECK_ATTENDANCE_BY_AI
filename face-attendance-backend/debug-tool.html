<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Matching Debug Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .card h2 {
            color: #333;
            margin-bottom: 16px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 12px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .result {
            margin-top: 16px;
            padding: 12px;
            border-radius: 8px;
            background: #f5f5f5;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
        }
        label {
            display: block;
            margin-top: 12px;
            font-weight: 600;
            color: #333;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin-bottom: 16px;
        }
        .success-text {
            color: #28a745;
            font-weight: 600;
        }
        .error-text {
            color: #dc3545;
            font-weight: 600;
        }
        .loading {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Face Matching Debug Tool</h1>

        <div class="grid">
            <!-- Profiles Viewer -->
            <div class="card">
                <h2>üìã Profiles Viewer</h2>
                <p>Ki·ªÉm tra t·∫•t c·∫£ profiles v√† embeddings trong database</p>
                <button onclick="viewProfiles()">üìä Xem Profiles</button>
                <div id="profilesResult" class="result"></div>
            </div>

            <!-- Test Matching -->
            <div class="card">
                <h2>üß™ Test Matching</h2>
                <label>Threshold (default: 0.6)</label>
                <input type="number" id="threshold" value="0.6" min="0" max="1" step="0.05">
                
                <label>Descriptor (128 numbers, ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ generate random)</label>
                <textarea id="descriptor" rows="4" placeholder="[0.1, 0.2, 0.3, ...]"></textarea>
                
                <button onclick="testMatching()">üöÄ Test</button>
                <div id="matchResult" class="result"></div>
            </div>

            <!-- Generate Random Descriptor -->
            <div class="card">
                <h2>üé≤ Generate Test Descriptor</h2>
                <p>T·∫°o descriptor random ƒë·ªÉ test</p>
                <label>Min value:</label>
                <input type="number" id="minVal" value="0" min="-1" max="1" step="0.1">
                
                <label>Max value:</label>
                <input type="number" id="maxVal" value="1" min="-1" max="1" step="0.1">
                
                <button onclick="generateDescriptor()">üé≤ Generate</button>
                <div id="generatedResult" class="result"></div>
            </div>

            <!-- Danger Zone -->
            <div class="card" style="border: 2px solid #dc3545;">
                <h2 style="border-color: #dc3545; color: #dc3545;">‚ö†Ô∏è Danger Zone</h2>
                <div class="warning">
                    ‚ö†Ô∏è These operations will DELETE data permanently!
                </div>
                <button onclick="clearAll()" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    üóëÔ∏è Clear All Data (Dev Only)
                </button>
                <div id="dangerResult" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';

        async function viewProfiles() {
            const resultDiv = document.getElementById('profilesResult');
            resultDiv.textContent = '‚è≥ Loading...';
            resultDiv.className = 'result info';

            try {
                const response = await fetch(`${API_BASE}/api/debug/profiles`);
                const data = await response.json();

                if (!response.ok) throw new Error(data.message);

                let output = `Total Profiles: ${data.totalProfiles}\n`;
                output += `Valid Profiles: ${data.validProfiles}\n\n`;
                
                data.profiles.forEach(p => {
                    const status = p.hasValidData ? '‚úÖ' : '‚ùå';
                    output += `[${p.id}] ${p.userName} (User: ${p.userId})\n`;
                    output += `    Type: ${p.embeddingsType}, IsArray: ${p.isArray}, Length: ${p.length}\n`;
                    output += `    Valid: ${status}\n\n`;
                });

                resultDiv.textContent = output;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function testMatching() {
            const resultDiv = document.getElementById('matchResult');
            const threshold = parseFloat(document.getElementById('threshold').value);
            let descriptorText = document.getElementById('descriptor').value.trim();

            resultDiv.textContent = '‚è≥ Testing...';
            resultDiv.className = 'result info';

            try {
                let descriptor;
                
                if (!descriptorText) {
                    // Generate random descriptor
                    descriptor = Array.from({ length: 128 }, () => Math.random());
                    resultDiv.textContent = '‚è≥ Generated random descriptor, testing...';
                } else {
                    // Parse input
                    descriptor = JSON.parse(descriptorText);
                    if (!Array.isArray(descriptor) || descriptor.length !== 128) {
                        throw new Error('Descriptor must be array of 128 numbers');
                    }
                }

                const response = await fetch(`${API_BASE}/api/debug/test-matching`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ descriptor, threshold })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.message);

                let output = `Matching Result:\n`;
                output += `================\n`;
                output += `Matched: ${data.matched ? '‚úÖ YES' : '‚ùå NO'}\n`;
                output += `Detected Name: ${data.detectedName}\n`;
                output += `Distance: ${data.distance?.toFixed(3) || 'N/A'}\n`;
                output += `Threshold: ${data.threshold}\n`;
                output += `User ID: ${data.userId || 'N/A'}\n`;
                output += `All Profiles: ${data.allProfiles}\n`;
                
                if (data.topMatch) {
                    output += `\nTop Match:\n`;
                    output += `  Name: ${data.topMatch.name}\n`;
                    output += `  Distance: ${data.topMatch.distance?.toFixed(3)}\n`;
                }

                resultDiv.textContent = output;
                resultDiv.className = data.matched ? 'result success' : 'result info';
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        function generateDescriptor() {
            const min = parseFloat(document.getElementById('minVal').value);
            const max = parseFloat(document.getElementById('maxVal').value);
            const descriptor = Array.from(
                { length: 128 },
                () => min + Math.random() * (max - min)
            );
            
            document.getElementById('descriptor').value = JSON.stringify(descriptor);
            
            const resultDiv = document.getElementById('generatedResult');
            resultDiv.textContent = `‚úÖ Generated random descriptor\nRange: [${min}, ${max}]\n\nCopied to descriptor field above. Click "Test" to test matching.`;
            resultDiv.className = 'result success';
        }

        async function clearAll() {
            if (!confirm('‚ö†Ô∏è This will DELETE ALL DATA! Are you sure?')) return;
            if (!confirm('‚ö†Ô∏è REALLY sure? This cannot be undone!')) return;

            const resultDiv = document.getElementById('dangerResult');
            resultDiv.textContent = 'üóëÔ∏è Clearing...';
            resultDiv.className = 'result info';

            try {
                const response = await fetch(`${API_BASE}/api/debug/clear-all`);
                const data = await response.json();

                if (!response.ok) throw new Error(data.message);

                let output = `‚úÖ Data Cleared Successfully!\n`;
                output += `Deleted:\n`;
                output += `  Logs: ${data.deleted.logs}\n`;
                output += `  Profiles: ${data.deleted.profiles}\n`;
                output += `  Users: ${data.deleted.users}\n`;

                resultDiv.textContent = output;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // Load profiles on page load
        window.onload = viewProfiles;
    </script>
</body>
</html>
